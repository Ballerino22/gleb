<!doctype html>
<html lang="ru">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>glebprosto RAG</title>
<style>
  body{font:16px/1.5 system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#0f1220;color:#e9ecf8}
  .wrap{max-width:800px;margin:40px auto;padding:0 16px}
  textarea{width:100%;min-height:110px;padding:12px;border-radius:10px;border:1px solid #2a3355;background:#0e1324;color:#e9ecf8}
  button{margin-top:10px;padding:12px 16px;border:0;border-radius:10px;cursor:pointer;background:#6ea8ff;color:#0a1020;font-weight:600}
  pre{white-space:pre-wrap;background:#0e1324;border:1px solid #2a3355;border-radius:10px;padding:12px;min-height:100px}
</style>
<div class="wrap">
  <h1>Ассистент по видео glebprosto</h1>
  <p style="opacity:.8">Введи вопрос и жми Enter/кнопку. Для первого шага нам важно лишь,
  чтобы <b>в n8n появился Execution</b>.</p>
  <textarea id="q" placeholder="Почему Глеб считает фильм «Дурак» плохим?"></textarea>
  <button id="ask">Спросить</button>
  <h3>Статус</h3>
  <pre id="out">—</pre>
</div>
<script>
  // ТВОЙ ПРОДОВЫЙ ВЕБХУК (НЕ /webhook-test/)
  const WEBHOOK_URL = "https://primary-production-7ec55.up.railway.app/webhook/87948bb9-1ee7-4796-b0d4-6428f77bde03";

  const $q = document.getElementById('q');
  const $out = document.getElementById('out');
  document.getElementById('ask').onclick = send;
  $q.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }});

  async function send(){
    const text = $q.value.trim();
    if(!text) return;
    const url = WEBHOOK_URL + "?chatInput=" + encodeURIComponent(text) + "&t=" + Date.now();
    $out.textContent = "Шлю GET…";

    // Пытаемся обычным fetch (если сервер вернёт CORS — прочитаем ответ)
    try {
      const res = await fetch(url, { method: "GET", cache: "no-store" });
      // Если ответ не ок — бросим в catch, чтобы сработал пиксель-фоллбек
      if (!res.ok) throw new Error(res.status + " " + res.statusText);
      // Некоторые конфиги не дают читать body — тоже пойдём в catch
      const data = await res.json().catch(() => null);
      $out.textContent = data ? "Отправлено. Ответ получен." : "Отправлено. Ответ прочитать нельзя — это норм для первого шага.";
    } catch (e) {
      // Фоллбек без CORS: всё равно пошлёт запрос, Execution появится в n8n
      const img = new Image();
      img.onload = () => { $out.textContent = "Отправлено (fallback). Проверь Executions в n8n."; };
      img.onerror = () => { $out.textContent = "Отправлено (fallback). Если Executions нет — проверь, что workflow Active и метод GET."; };
      img.src = url + "&pixel=1";
    }
  }
</script>
</html>
